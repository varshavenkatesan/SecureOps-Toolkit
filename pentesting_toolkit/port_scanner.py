#!/usr/bin/env python3
"""
Port Scanner
============
Network port scanner for discovering open ports on target systems.

Author: Varsha Venkatesan
Purpose: Educational - Authorized Network Testing Only

⚠️ WARNING: Only scan networks/systems you own or have permission to test!
Unauthorized port scanning may be illegal and is considered hostile activity.
"""

import socket
import threading
from queue import Queue
import time
from datetime import datetime

from utils import (
    validate_ip,
    validate_hostname,
    resolve_hostname,
    validate_port_range,
    get_service_name,
    get_common_ports,
    print_banner,
    print_section,
    confirm_action
)


class PortScanner:
    """
    TCP port scanner for network reconnaissance.
    """
    
    def __init__(self, target, timeout=1, threads=10):
        """
        Initialize the port scanner.
        
        Args:
            target (str): Target IP or hostname
            timeout (float): Connection timeout in seconds
            threads (int): Number of concurrent threads
        """
        self.target = target
        self.target_ip = None
        self.timeout = timeout
        self.threads = threads
        self.open_ports = []
        self.scan_queue = Queue()
        self.lock = threading.Lock()
        
    def resolve_target(self):
        """
        Resolve target hostname to IP address.
        
        Returns:
            bool: True if resolution successful
        """
        # Check if target is already an IP
        if validate_ip(self.target):
            self.target_ip = self.target
            return True
        
        # Check if target is a valid hostname
        if validate_hostname(self.target):
            print(f"[*] Resolving hostname: {self.target}")
            self.target_ip = resolve_hostname(self.target)
            
            if self.target_ip:
                print(f"[+] Resolved to: {self.target_ip}")
                return True
            else:
                print(f"[!] Failed to resolve hostname: {self.target}")
                return False
        
        print(f"[!] Invalid target: {self.target}")
        return False
    
    def scan_port(self, port):
        """
        Scan a single port using TCP connect.
        
        Args:
            port (int): Port number to scan
            
        Returns:
            bool: True if port is open
        """
        try:
            # Create TCP socket
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(self.timeout)
            
            # Attempt connection
            result = sock.connect_ex((self.target_ip, port))
            sock.close()
            
            # Result 0 means successful connection (open port)
            return result == 0
            
        except socket.error:
            return False
        except Exception:
            return False
    
    def worker(self):
        """
        Worker thread function for scanning ports from queue.
        """
        while True:
            port = self.scan_queue.get()
            
            if port is None:
                break
            
            if self.scan_port(port):
                service = get_service_name(port)
                
                with self.lock:
                    self.open_ports.append((port, service))
                    print(f"[+] Port {port:5d}/tcp  open  {service}")
            
            self.scan_queue.task_done()
    
    def scan_ports(self, start_port, end_port):
        """
        Scan a range of ports using multithreading.
        
        Args:
            start_port (int): Starting port number
            end_port (int): Ending port number
        """
        print_section("SCAN CONFIGURATION")
        print(f"Target:      {self.target}")
        print(f"IP Address:  {self.target_ip}")
        print(f"Port Range:  {start_port}-{end_port}")
        print(f"Timeout:     {self.timeout}s")
        print(f"Threads:     {self.threads}")
        
        # Calculate total ports
        total_ports = end_port - start_port + 1
        print(f"Total Ports: {total_ports}")
        
        print_section("SCANNING IN PROGRESS")
        print("[*] Starting port scan...")
        start_time = time.time()
        
        # Start worker threads
        threads_list = []
        for _ in range(self.threads):
            thread = threading.Thread(target=self.worker)
            thread.daemon = True
            thread.start()
            threads_list.append(thread)
        
        # Add ports to queue
        for port in range(start_port, end_port + 1):
            self.scan_queue.put(port)
        
        # Wait for all tasks to complete
        self.scan_queue.join()
        
        # Stop worker threads
        for _ in range(self.threads):
            self.scan_queue.put(None)
        
        for thread in threads_list:
            thread.join()
        
        # Calculate elapsed time
        elapsed_time = time.time() - start_time
        
        # Display results
        self.display_results(total_ports, elapsed_time)
    
    def scan_common_ports(self):
        """
        Scan commonly used ports.
        """
        common_ports = get_common_ports()
        
        print_section("SCAN CONFIGURATION")
        print(f"Target:      {self.target}")
        print(f"IP Address:  {self.target_ip}")
        print(f"Scan Type:   Common Ports")
        print(f"Total Ports: {len(common_ports)}")
        
        print_section("SCANNING IN PROGRESS")
        print("[*] Scanning common ports...")
        start_time = time.time()
        
        # Start worker threads
        threads_list = []
        for _ in range(min(self.threads, len(common_ports))):
            thread = threading.Thread(target=self.worker)
            thread.daemon = True
            thread.start()
            threads_list.append(thread)
        
        # Add ports to queue
        for port in common_ports:
            self.scan_queue.put(port)
        
        # Wait for all tasks to complete
        self.scan_queue.join()
        
        # Stop worker threads
        for _ in range(len(threads_list)):
            self.scan_queue.put(None)
        
        for thread in threads_list:
            thread.join()
        
        # Calculate elapsed time
        elapsed_time = time.time() - start_time
        
        # Display results
        self.display_results(len(common_ports), elapsed_time)
    
    def display_results(self, total_scanned, elapsed_time):
        """
        Display scan results summary.
        
        Args:
            total_scanned (int): Total number of ports scanned
            elapsed_time (float): Time taken for scan
        """
        print_section("SCAN RESULTS")
        
        print(f"\nScan Date:      {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"Target:         {self.target} ({self.target_ip})")
        print(f"Ports Scanned:  {total_scanned}")
        print(f"Open Ports:     {len(self.open_ports)}")
        print(f"Elapsed Time:   {elapsed_time:.2f} seconds")
        
        if self.open_ports:
            print("\n" + "="*60)
            print("OPEN PORTS SUMMARY")
            print("="*60)
            print(f"{'PORT':<10} {'STATE':<10} {'SERVICE':<20}")
            print("-"*60)
            
            # Sort by port number
            self.open_ports.sort(key=lambda x: x[0])
            
            for port, service in self.open_ports:
                print(f"{port:<10} {'open':<10} {service:<20}")
        else:
            print("\n[*] No open ports found")
        
        print("\n" + "="*60)


def main():
    """
    Main function to run the port scanner interactively.
    """
    print_banner("NETWORK PORT SCANNER")
    
    print("\n⚠️  ETHICAL USAGE WARNING ⚠️")
    print("This tool is for AUTHORIZED network testing only!")
    print("Only scan systems you own or have explicit permission to test.")
    print("Unauthorized port scanning is illegal and unethical.\n")
    
    # Get target
    target = input("Enter target IP or hostname: ").strip()
    
    if not target:
        print("[!] No target provided. Exiting.")
        return
    
    # Initialize scanner
    scanner = PortScanner(target, timeout=1, threads=50)
    
    # Resolve target
    if not scanner.resolve_target():
        print("[!] Unable to resolve target. Exiting.")
        return
    
    # Confirm authorization
    if not confirm_action("\n[?] Do you have authorization to scan this target?"):
        print("[!] Scan cancelled. Authorization not confirmed.")
        return
    
    # Select scan type
    print("\n--- SCAN TYPE ---")
    print("1. Scan Common Ports (Fast)")
    print("2. Scan Port Range")
    print("3. Scan All Ports (1-65535) - Very Slow!")
    
    choice = input("\nEnter your choice (1-3): ").strip()
    
    try:
        if choice == '1':
            # Scan common ports
            scanner.scan_common_ports()
            
        elif choice == '2':
            # Scan custom port range
            port_range = input("Enter port range (e.g., 1-1000): ").strip()
            start_port, end_port = validate_port_range(port_range)
            
            if start_port is None:
                print("[!] Invalid port range")
                return
            
            scanner.scan_ports(start_port, end_port)
            
        elif choice == '3':
            # Scan all ports (warn user)
            print("\n[!] WARNING: Scanning all 65535 ports will take a long time!")
            if confirm_action("[?] Are you sure you want to continue?"):
                scanner.scan_ports(1, 65535)
            else:
                print("[*] Scan cancelled.")
                return
        else:
            print("[!] Invalid choice")
            return
            
    except KeyboardInterrupt:
        print("\n\n[!] Scan interrupted by user")
        print(f"[*] Partial results: {len(scanner.open_ports)} open ports found")
    except Exception as e:
        print(f"\n[ERROR] Scan failed: {e}")
    
    print("\n[*] Port scan complete!")


if __name__ == "__main__":
    main()
