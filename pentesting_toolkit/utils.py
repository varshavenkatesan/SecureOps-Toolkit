#!/usr/bin/env python3
"""
Penetration Testing Toolkit - Utility Functions
================================================
Common utility functions used across pentesting modules.

Author: Varsha Venkatesan
Purpose: Educational - Authorized Testing Only
"""

import socket
import re
from datetime import datetime


def validate_ip(ip_address):
    """
    Validate IPv4 address format.
    
    Args:
        ip_address (str): IP address to validate
        
    Returns:
        bool: True if valid IPv4 address
    """
    pattern = re.compile(r'^(\d{1,3}\.){3}\d{1,3}$')
    
    if not pattern.match(ip_address):
        return False
    
    # Check each octet is 0-255
    octets = ip_address.split('.')
    for octet in octets:
        if int(octet) > 255:
            return False
    
    return True


def validate_hostname(hostname):
    """
    Validate hostname format.
    
    Args:
        hostname (str): Hostname to validate
        
    Returns:
        bool: True if valid hostname
    """
    if len(hostname) > 255:
        return False
    
    # Allow alphanumeric, hyphens, and dots
    pattern = re.compile(r'^[a-zA-Z0-9.-]+$')
    return bool(pattern.match(hostname))


def resolve_hostname(hostname):
    """
    Resolve hostname to IP address.
    
    Args:
        hostname (str): Hostname to resolve
        
    Returns:
        str: IP address or None if resolution fails
    """
    try:
        ip_address = socket.gethostbyname(hostname)
        return ip_address
    except socket.gaierror:
        return None


def validate_port(port):
    """
    Validate port number.
    
    Args:
        port (int or str): Port number to validate
        
    Returns:
        bool: True if valid port (1-65535)
    """
    try:
        port_num = int(port)
        return 1 <= port_num <= 65535
    except (ValueError, TypeError):
        return False


def validate_port_range(port_range):
    """
    Validate port range format (e.g., "80-443").
    
    Args:
        port_range (str): Port range string
        
    Returns:
        tuple: (start_port, end_port) or (None, None) if invalid
    """
    try:
        if '-' in port_range:
            start, end = port_range.split('-')
            start_port = int(start)
            end_port = int(end)
            
            if validate_port(start_port) and validate_port(end_port):
                if start_port <= end_port:
                    return (start_port, end_port)
        else:
            # Single port
            port = int(port_range)
            if validate_port(port):
                return (port, port)
    except (ValueError, AttributeError):
        pass
    
    return (None, None)


def get_service_name(port):
    """
    Get common service name for a port number.
    
    Args:
        port (int): Port number
        
    Returns:
        str: Service name or 'unknown'
    """
    common_ports = {
        20: 'FTP-DATA',
        21: 'FTP',
        22: 'SSH',
        23: 'Telnet',
        25: 'SMTP',
        53: 'DNS',
        80: 'HTTP',
        110: 'POP3',
        143: 'IMAP',
        443: 'HTTPS',
        445: 'SMB',
        3306: 'MySQL',
        3389: 'RDP',
        5432: 'PostgreSQL',
        5900: 'VNC',
        8080: 'HTTP-Proxy',
        8443: 'HTTPS-Alt',
    }
    
    return common_ports.get(port, 'unknown')


def format_timestamp():
    """
    Get formatted timestamp for logging.
    
    Returns:
        str: Formatted timestamp
    """
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")


def print_banner(title):
    """
    Print a formatted banner.
    
    Args:
        title (str): Banner title
    """
    width = 60
    print("\n" + "="*width)
    print(title.center(width))
    print("="*width)


def print_section(title):
    """
    Print a formatted section header.
    
    Args:
        title (str): Section title
    """
    print("\n" + "-"*60)
    print(title)
    print("-"*60)


def confirm_action(message):
    """
    Ask user for confirmation.
    
    Args:
        message (str): Confirmation message
        
    Returns:
        bool: True if user confirms
    """
    response = input(f"{message} (yes/no): ").strip().lower()
    return response == 'yes'


def get_common_ports():
    """
    Get list of commonly scanned ports.
    
    Returns:
        list: List of common port numbers
    """
    return [
        21,    # FTP
        22,    # SSH
        23,    # Telnet
        25,    # SMTP
        53,    # DNS
        80,    # HTTP
        110,   # POP3
        143,   # IMAP
        443,   # HTTPS
        445,   # SMB
        3306,  # MySQL
        3389,  # RDP
        5432,  # PostgreSQL
        8080,  # HTTP-Proxy
    ]


def sanitize_input(user_input, max_length=100):
    """
    Sanitize user input to prevent injection attacks.
    
    Args:
        user_input (str): Raw user input
        max_length (int): Maximum allowed length
        
    Returns:
        str: Sanitized input
    """
    if not user_input:
        return ""
    
    # Remove potentially dangerous characters
    sanitized = re.sub(r'[;&|`$]', '', user_input)
    
    # Truncate to max length
    sanitized = sanitized[:max_length]
    
    return sanitized.strip()


if __name__ == "__main__":
    # Test utility functions
    print_banner("PENTESTING UTILITIES TEST")
    
    # Test IP validation
    print("\n[*] Testing IP validation:")
    test_ips = ['192.168.1.1', '256.1.1.1', '10.0.0.1', 'invalid']
    for ip in test_ips:
        result = validate_ip(ip)
        print(f"  {ip}: {'Valid' if result else 'Invalid'}")
    
    # Test port validation
    print("\n[*] Testing port validation:")
    test_ports = [80, 65536, -1, '443', 'invalid']
    for port in test_ports:
        result = validate_port(port)
        print(f"  {port}: {'Valid' if result else 'Invalid'}")
    
    # Test service names
    print("\n[*] Common port services:")
    for port in get_common_ports()[:5]:
        service = get_service_name(port)
        print(f"  Port {port}: {service}")
